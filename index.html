<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To√°n 11 - Premium AI Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
    
    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        :root {
            --bg: #0f172a;
            --primary: #38bdf8;
            --accent: #818cf8;
            --glass: rgba(30, 41, 59, 0.75);
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: radial-gradient(circle at top right, #1e293b, #0f172a);
            color: #f1f5f9;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
        }

        .premium-card {
            background: var(--glass);
            backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 600px;
            border-radius: 2rem;
            padding: 2.5rem;
        }

        .input-glow {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .input-glow:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(56, 189, 248, 0.15);
            outline: none;
        }

        .btn-action {
            background: linear-gradient(135deg, #38bdf8 0%, #818cf8 100%);
            color: #0f172a;
            font-weight: 800;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-action:hover:not(:disabled) {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 12px 24px -6px rgba(56, 189, 248, 0.5);
        }

        .option-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .option-card:hover {
            background: rgba(255, 255, 255, 0.06);
            transform: translateX(4px);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .loader {
            width: 40px;
            height: 40px;
            border: 4px solid #1e293b;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #38bdf8, #818cf8);
            transition: width 0.4s ease;
        }
    </style>
</head>
<body>

    <div id="app-container">
        <!-- Setup Screen -->
        <div id="setup-screen" class="premium-card space-y-8">
            <div class="text-center space-y-2">
                <div class="inline-block px-3 py-1 bg-sky-500/10 text-sky-400 text-[10px] font-bold uppercase tracking-widest rounded-full border border-sky-500/20">AI Education System</div>
                <h1 class="text-4xl font-black text-white">To√°n 11 <span class="text-sky-400">Mastery</span></h1>
                <p class="text-slate-400 text-sm">H·ªçc t·∫≠p th√¥ng minh h∆°n v·ªõi ƒë·ªÅ b√†i ƒë∆∞·ª£c c√° nh√¢n h√≥a.</p>
            </div>

            <div class="space-y-5">
                <div>
                    <label class="text-[11px] font-bold text-slate-500 uppercase ml-2 mb-2 block">T√™n c·ªßa b·∫°n</label>
                    <input type="text" id="username" placeholder="V√≠ d·ª•: Minh Anh" class="w-full input-glow p-4 rounded-2xl text-white">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[11px] font-bold text-slate-500 uppercase ml-2 mb-2 block">Ch·ªß ƒë·ªÅ</label>
                        <select id="quiz-topic" class="w-full input-glow p-4 rounded-2xl text-white appearance-none cursor-pointer">
                            <option value="H√†m s·ªë l∆∞·ª£ng gi√°c">H√†m s·ªë l∆∞·ª£ng gi√°c</option>
                            <option value="D√£y s·ªë, C·∫•p s·ªë c·ªông/nh√¢n">D√£y s·ªë & C·∫•p s·ªë</option>
                            <option value="Gi·ªõi h·∫°n & H√†m s·ªë li√™n t·ª•c">Gi·ªõi h·∫°n & Li√™n t·ª•c</option>
                            <option value="H√¨nh h·ªçc kh√¥ng gian">H√¨nh h·ªçc kh√¥ng gian</option>
                            <option value="To√†n b·ªô ch∆∞∆°ng tr√¨nh">T·ªïng h·ª£p ki·∫øn th·ª©c</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[11px] font-bold text-slate-500 uppercase ml-2 mb-2 block">M·ª©c ƒë·ªô</label>
                        <select id="quiz-level" class="w-full input-glow p-4 rounded-2xl text-white appearance-none cursor-pointer">
                            <option value="C∆° b·∫£n (Th√¥ng hi·ªÉu)">C∆° b·∫£n</option>
                            <option value="V·∫≠n d·ª•ng (Kh√°)">V·∫≠n d·ª•ng</option>
                            <option value="N√¢ng cao (V·∫≠n d·ª•ng cao)">N√¢ng cao</option>
                        </select>
                    </div>
                </div>

                <button onclick="generateQuiz()" id="start-btn" class="w-full p-5 rounded-2xl btn-action text-lg shadow-xl">
                    B·∫Øt ƒë·∫ßu l√†m b√†i
                </button>
            </div>

            <div class="pt-6 border-t border-white/5">
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4 flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-sky-400"></span> B·∫£ng x·∫øp h·∫°ng
                </h3>
                <div id="leaderboard" class="space-y-3 max-h-[200px] overflow-y-auto pr-2">
                    <div class="text-center py-4 text-slate-600 text-xs">ƒêang t·∫£i d·ªØ li·ªáu...</div>
                </div>
            </div>
        </div>

        <!-- Loading Screen -->
        <div id="loading-screen" class="hidden premium-card flex flex-col items-center justify-center space-y-6 py-20">
            <div class="loader"></div>
            <div class="text-center">
                <h2 class="text-xl font-bold text-white">AI ƒëang so·∫°n ƒë·ªÅ...</h2>
                <p class="text-slate-400 text-sm mt-1">Qu√° tr√¨nh n√†y m·∫•t kho·∫£ng 3-5 gi√¢y</p>
            </div>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz-screen" class="hidden premium-card space-y-6">
            <div class="flex items-center justify-between">
                <span id="quiz-info" class="text-[11px] font-bold text-slate-500 uppercase tracking-widest">C√ÇU H·ªéI 1 / 10</span>
                <span id="timer" class="text-sm font-black text-sky-400 tabular-nums">00:00</span>
            </div>
            
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill" style="width: 10%"></div>
            </div>

            <div id="question-area" class="py-4">
                <p id="question-text" class="text-xl font-bold text-slate-100 leading-relaxed"></p>
            </div>

            <div id="options-area" class="space-y-3"></div>
        </div>

        <!-- Result Screen -->
        <div id="result-screen" class="hidden premium-card text-center space-y-8">
            <div class="text-6xl">üéâ</div>
            <div class="space-y-2">
                <h2 class="text-3xl font-black text-white">Ho√†n th√†nh!</h2>
                <p id="score-summary" class="text-slate-400 font-medium"></p>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-slate-900/50 p-6 rounded-3xl border border-white/5">
                    <div class="text-[10px] font-bold text-slate-500 uppercase mb-1">ƒêi·ªÉm s·ªë</div>
                    <div id="final-points" class="text-3xl font-black text-sky-400">0/0</div>
                </div>
                <div class="bg-slate-900/50 p-6 rounded-3xl border border-white/5">
                    <div class="text-[10px] font-bold text-slate-500 uppercase mb-1">Th·ªùi gian</div>
                    <div id="final-time" class="text-3xl font-black text-white">0s</div>
                </div>
            </div>
            <button onclick="location.reload()" class="w-full p-5 rounded-2xl bg-white text-slate-900 font-bold hover:bg-slate-100 transition-all">L√†m b√†i m·ªõi</button>
        </div>
    </div>

    <script>
        const apiKey = "AIzaSyC-HhJtXxvmCCGUpK8WG9LWJnk8hkEiTRg";
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'toan11-premium';

        let questions = [];
        let currentIdx = 0;
        let score = 0;
        let startTime, timerInterval;
        let userName = "";

        async function fetchWithRetry(url, options, retries = 5, backoff = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return await response.json();
                } catch (err) {}
                await new Promise(r => setTimeout(r, backoff * Math.pow(2, i)));
            }
            throw new Error("API Connection Failed");
        }

        async function generateQuiz() {
            userName = document.getElementById('username').value.trim() || "Ng∆∞·ªùi d√πng";
            const topic = document.getElementById('quiz-topic').value;
            const level = document.getElementById('quiz-level').value;

            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('loading-screen').classList.remove('hidden');

            const prompt = `B·∫°n l√† chuy√™n gia gi√°o d·ª•c. H√£y so·∫°n 10 c√¢u h·ªèi tr·∫Øc nghi·ªám To√°n 11, ch·ªß ƒë·ªÅ: ${topic}, m·ª©c ƒë·ªô: ${level}. ƒê·ªãnh d·∫°ng JSON: [{"q": "C√¢u h·ªèi (D√πng Latex $ n·∫øu c·∫ßn)", "a": ["ƒê√°p √°n A", "ƒê√°p √°n B", "ƒê√°p √°n C", "ƒê√°p √°n D"], "c": index_ƒë√∫ng_0_ƒë·∫øn_3}]. Ch·ªâ tr·∫£ v·ªÅ JSON.`;

            try {
                const data = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const rawText = data.candidates[0].content.parts[0].text;
                questions = JSON.parse(rawText.replace(/```json|```/g, '').trim());
                
                startQuiz();
            } catch (err) {
                alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi AI. Vui l√≤ng ki·ªÉm tra API Key ho·∫∑c th·ª≠ l·∫°i.");
                location.reload();
            }
        }

        function startQuiz() {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            startTime = Date.now();
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
            renderQuestion();
        }

        function updateTimer() {
            const diff = Math.floor((Date.now() - startTime) / 1000);
            const m = Math.floor(diff / 60).toString().padStart(2, '0');
            const s = (diff % 60).toString().padStart(2, '0');
            document.getElementById('timer').innerText = `${m}:${s}`;
        }

        function renderQuestion() {
            const q = questions[currentIdx];
            document.getElementById('quiz-info').innerText = `C√ÇU H·ªéI ${currentIdx + 1} / ${questions.length}`;
            document.getElementById('progress-fill').style.width = `${((currentIdx + 1) / questions.length) * 100}%`;
            document.getElementById('question-text').innerHTML = q.q;

            const optionsDiv = document.getElementById('options-area');
            optionsDiv.innerHTML = '';

            q.a.forEach((opt, i) => {
                const btn = document.createElement('div');
                btn.className = "option-card p-4 rounded-xl flex items-center gap-4 group";
                btn.innerHTML = `
                    <div class="w-8 h-8 flex items-center justify-center rounded-lg bg-slate-800 text-[10px] font-black group-hover:bg-sky-500 group-hover:text-slate-900 transition-colors">
                        ${String.fromCharCode(65 + i)}
                    </div>
                    <div class="text-sm font-medium text-slate-300 group-hover:text-white">${opt}</div>
                `;
                btn.onclick = () => checkAnswer(i);
                optionsDiv.appendChild(btn);
            });

            renderMathInElement(document.body, { delimiters: [{left: '$', right: '$', display: false}] });
        }

        function checkAnswer(idx) {
            if (idx === questions[currentIdx].c) score++;
            
            if (currentIdx < questions.length - 1) {
                currentIdx++;
                renderQuestion();
            } else {
                finishQuiz();
            }
        }

        async function finishQuiz() {
            clearInterval(timerInterval);
            const timeTaken = Math.floor((Date.now() - startTime) / 1000);
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');

            document.getElementById('final-points').innerText = `${score}/${questions.length}`;
            document.getElementById('final-time').innerText = `${timeTaken}s`;
            document.getElementById('score-summary').innerText = score >= 8 ? "Qu√° tuy·ªát v·ªùi!" : "Kh√° t·ªët, h√£y c·ªë g·∫Øng th√™m nh√©!";

            try {
                if (!auth.currentUser) await auth.signInAnonymously();
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('leaderboard').add({
                    name: userName,
                    score: score,
                    time: timeTaken,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                loadLeaderboard();
            } catch (e) {}
        }

        async function loadLeaderboard() {
            try {
                const snap = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('leaderboard').get();
                let list = [];
                snap.forEach(doc => list.push(doc.data()));
                list.sort((a, b) => b.score - a.score || a.time - b.time);

                const container = document.getElementById('leaderboard');
                if (list.length === 0) {
                    container.innerHTML = `<div class="text-center py-4 text-slate-600 text-xs">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>`;
                    return;
                }

                container.innerHTML = list.slice(0, 10).map((item, i) => `
                    <div class="flex items-center justify-between p-3 bg-white/5 rounded-xl border border-white/5">
                        <div class="flex items-center gap-3">
                            <span class="text-[10px] font-black text-slate-500">${i+1}</span>
                            <span class="text-xs font-bold text-slate-200">${item.name}</span>
                        </div>
                        <div class="text-right">
                            <div class="text-xs font-black text-sky-400">${item.score}/10</div>
                            <div class="text-[9px] text-slate-500">${item.time}s</div>
                        </div>
                    </div>
                `).join('');
            } catch (e) {}
        }

        window.onload = loadLeaderboard;
    </script>
</body>
</html>