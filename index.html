<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To√°n 11 - AI Quiz & Leaderboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
    
    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f1f5f9; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .option-btn { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.2s ease; }
        .option-btn:hover:not(:disabled) { background: rgba(56, 189, 248, 0.1); border-color: #38bdf8; transform: translateY(-2px); }
        .option-btn.correct { background: rgba(16, 185, 129, 0.2) !important; border-color: #10b981 !important; color: #34d399; }
        .option-btn.wrong { background: rgba(239, 68, 68, 0.2) !important; border-color: #ef4444 !important; color: #f87171; }
        .shimmer { background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent); background-size: 200% 100%; animation: shimmer 2s infinite; }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="app-container" class="w-full max-w-xl">
        <!-- Setup Screen -->
        <div id="setup-screen" class="glass-panel rounded-3xl p-8 space-y-6 shadow-2xl">
            <div class="text-center space-y-2">
                <h1 class="text-3xl font-extrabold text-white">To√°n 11 <span class="text-sky-400">AI Quiz</span></h1>
                <p class="text-slate-400 text-sm">ƒê·ªÅ thi t·∫°o b·ªüi AI & L∆∞u ƒëi·ªÉm Cloud</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">T√™n h·ªçc sinh</label>
                    <input type="text" id="username" placeholder="Nh·∫≠p t√™n ƒë·ªÉ l∆∞u BXH..." class="w-full bg-slate-800/50 border border-slate-700 p-4 rounded-xl outline-none focus:border-sky-500 text-white">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">S·ªë l∆∞·ª£ng c√¢u</label>
                        <select id="quiz-limit" class="w-full bg-slate-800/50 border border-slate-700 p-4 rounded-xl outline-none text-white appearance-none cursor-pointer">
                            <option value="5">5 c√¢u</option>
                            <option value="10" selected>10 c√¢u</option>
                            <option value="15">15 c√¢u</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">ƒê·ªô kh√≥</label>
                        <select id="quiz-level" class="w-full bg-slate-800/50 border border-slate-700 p-4 rounded-xl outline-none text-white appearance-none cursor-pointer">
                            <option value="c∆° b·∫£n">C∆° b·∫£n</option>
                            <option value="kh√°">Th√¥ng hi·ªÉu</option>
                            <option value="n√¢ng cao">V·∫≠n d·ª•ng cao</option>
                        </select>
                    </div>
                </div>

                <button onclick="prepareQuiz()" id="start-btn" class="w-full py-4 bg-sky-500 hover:bg-sky-400 text-slate-900 font-bold rounded-xl transition-all shadow-lg shadow-sky-500/20 active:scale-[0.98]">
                    B·∫Øt ƒë·∫ßu b√†i thi AI
                </button>
            </div>

            <!-- Leaderboard Area -->
            <div class="pt-6 border-t border-slate-700/50">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xs font-black text-slate-500 uppercase tracking-widest">üèÜ B·∫£ng x·∫øp h·∫°ng Top 10</h2>
                    <button onclick="loadLeaderboard()" class="text-[10px] text-sky-400 hover:underline">L√†m m·ªõi</button>
                </div>
                <div id="leaderboard-list" class="space-y-2 max-h-40 overflow-y-auto pr-2">
                    <p class="text-center text-xs text-slate-600 italic">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                </div>
            </div>

            <div id="loading-area" class="hidden space-y-4 animate-pulse">
                <div class="h-2 w-full bg-slate-800 rounded-full overflow-hidden">
                    <div class="shimmer h-full w-full"></div>
                </div>
                <p class="text-center text-xs text-slate-500 font-medium">AI ƒëang so·∫°n th·∫£o b·ªô ƒë·ªÅ ri√™ng cho b·∫°n...</p>
            </div>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz-screen" class="hidden glass-panel rounded-3xl p-8 space-y-6 relative overflow-hidden">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div id="timer" class="text-sm font-mono font-bold text-sky-400 bg-sky-500/10 px-3 py-1 rounded-lg">00:00</div>
                    <div id="progress-tag" class="text-[10px] font-black text-slate-500 uppercase tracking-wider">C√¢u 1/10</div>
                </div>
                <div id="score-tag" class="text-xs font-bold text-emerald-400">ƒê√∫ng: 0</div>
            </div>

            <div class="min-h-[100px]">
                <h2 id="question-text" class="text-lg md:text-xl font-semibold text-slate-100 leading-relaxed"></h2>
            </div>

            <div id="options-container" class="grid grid-cols-1 gap-3"></div>
        </div>

        <!-- Result Screen -->
        <div id="result-screen" class="hidden glass-panel rounded-3xl p-8 text-center space-y-6">
            <div class="text-5xl">üéØ</div>
            <h2 class="text-2xl font-bold text-white">K·∫øt qu·∫£ b√†i thi</h2>
            <div class="flex justify-center gap-4">
                <div class="bg-slate-800/50 p-4 rounded-2xl w-1/2 border border-slate-700">
                    <p class="text-[10px] text-slate-500 uppercase font-black">ƒêi·ªÉm s·ªë</p>
                    <p id="final-score" class="text-2xl font-bold text-sky-400">0/0</p>
                </div>
                <div class="bg-slate-800/50 p-4 rounded-2xl w-1/2 border border-slate-700">
                    <p class="text-[10px] text-slate-500 uppercase font-black">Th·ªùi gian</p>
                    <p id="final-time" class="text-2xl font-bold text-white">0s</p>
                </div>
            </div>
            <div id="save-status" class="text-[10px] text-slate-500 italic">ƒêang l∆∞u ƒëi·ªÉm l√™n h·ªá th·ªëng...</div>
            <button onclick="location.reload()" class="w-full py-4 bg-slate-700 hover:bg-slate-600 text-white font-bold rounded-xl transition-all">Quay l·∫°i trang ch·ªß</button>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const apiKey = ""; // Gemini API Key
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'toan11-ai-quiz';

        let currentQuestions = [];
        let currentIndex = 0;
        let score = 0;
        let seconds = 0;
        let timerInterval;
        let isLocked = false;
        let userName = "";

        // --- FIREBASE LOGIC ---
        async function loadLeaderboard() {
            const list = document.getElementById('leaderboard-list');
            try {
                // S·ª≠ d·ª•ng ƒë∆∞·ªùng d·∫´n chu·∫©n theo y√™u c·∫ßu b·∫£o m·∫≠t
                const snapshot = await db.collection('artifacts').doc(appId)
                    .collection('public').doc('data').collection('leaderboard')
                    .get();

                let entries = [];
                snapshot.forEach(doc => entries.push(doc.data()));
                
                // S·∫Øp x·∫øp: ƒêi·ªÉm cao nh·∫•t, n·∫øu b·∫±ng ƒëi·ªÉm th√¨ th·ªùi gian √≠t nh·∫•t
                entries.sort((a, b) => b.score - a.score || a.time - b.time);
                entries = entries.slice(0, 10);

                if (entries.length === 0) {
                    list.innerHTML = `<p class="text-center text-xs text-slate-600">Ch∆∞a c√≥ d·ªØ li·ªáu x·∫øp h·∫°ng.</p>`;
                    return;
                }

                list.innerHTML = entries.map((item, i) => `
                    <div class="flex justify-between items-center p-3 bg-slate-800/30 rounded-xl border border-white/5">
                        <div class="flex items-center gap-3">
                            <span class="text-[10px] font-black ${i < 3 ? 'text-sky-400' : 'text-slate-500'}">#${i+1}</span>
                            <span class="text-xs font-semibold text-slate-300 truncate max-w-[120px]">${item.name}</span>
                        </div>
                        <div class="text-right">
                            <span class="text-xs font-bold text-sky-400">${item.score}ƒë</span>
                            <span class="text-[9px] text-slate-500 ml-1">(${item.time}s)</span>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error(error);
                list.innerHTML = `<p class="text-center text-xs text-red-400/50">Kh√¥ng th·ªÉ t·∫£i BXH.</p>`;
            }
        }

        async function saveResultToCloud() {
            const statusEl = document.getElementById('save-status');
            try {
                // ƒêƒÉng nh·∫≠p ·∫©n danh ƒë·ªÉ c√≥ quy·ªÅn ghi
                if (!auth.currentUser) await auth.signInAnonymously();
                
                await db.collection('artifacts').doc(appId)
                    .collection('public').doc('data').collection('leaderboard')
                    .add({
                        name: userName,
                        score: score,
                        total: currentQuestions.length,
                        time: seconds,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                
                statusEl.innerText = "‚úÖ ƒêi·ªÉm c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c l∆∞u!";
                statusEl.classList.add('text-emerald-400');
            } catch (error) {
                console.error(error);
                statusEl.innerText = "‚ùå Kh√¥ng th·ªÉ l∆∞u ƒëi·ªÉm t·ª± ƒë·ªông.";
            }
        }

        // --- AI LOGIC ---
        async function generateAIQuestions(level, limit) {
            const systemPrompt = `B·∫°n l√† m·ªôt chuy√™n gia gi√°o d·ª•c To√°n 11 Vi·ªát Nam. 
            T·∫°o b·ªô ƒë·ªÅ tr·∫Øc nghi·ªám ${limit} c√¢u, tr√¨nh ƒë·ªô ${level}. 
            N·ªôi dung: L∆∞·ª£ng gi√°c, C·∫•p s·ªë, Gi·ªõi h·∫°n, H√¨nh kh√¥ng gian. 
            S·ª≠ d·ª•ng LaTeX ($...$ inline, $$...$$ display).
            JSON duy nh·∫•t: [{"q": "c√¢u h·ªèi", "a": ["ƒë√°p √°n A", "B", "C", "D"], "c": index_ƒë√∫ng_0_3}].`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `So·∫°n ${limit} c√¢u To√°n 11 m·ª©c ƒë·ªô ${level}.` }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                const result = await response.json();
                return JSON.parse(result.candidates[0].content.parts[0].text);
            } catch (error) {
                throw error;
            }
        }

        // --- APP FLOW ---
        async function prepareQuiz() {
            userName = document.getElementById('username').value.trim();
            if (!userName) return alert("Vui l√≤ng nh·∫≠p t√™n c·ªßa b·∫°n");

            const level = document.getElementById('quiz-level').value;
            const limit = document.getElementById('quiz-limit').value;
            const startBtn = document.getElementById('start-btn');
            const loading = document.getElementById('loading-area');

            startBtn.disabled = true;
            startBtn.classList.add('opacity-50');
            loading.classList.remove('hidden');

            try {
                currentQuestions = await generateAIQuestions(level, limit);
                startQuiz();
            } catch (error) {
                alert("L·ªói k·∫øt n·ªëi AI. Ki·ªÉm tra API Key ho·∫∑c th·ª≠ l·∫°i.");
                startBtn.disabled = false;
                startBtn.classList.remove('opacity-50');
                loading.classList.add('hidden');
            }
        }

        function startQuiz() {
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            currentIndex = 0;
            score = 0;
            seconds = 0;
            startTimer();
            showQuestion();
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                seconds++;
                let m = Math.floor(seconds / 60).toString().padStart(2, '0');
                let s = (seconds % 60).toString().padStart(2, '0');
                document.getElementById('timer').innerText = `${m}:${s}`;
            }, 1000);
        }

        function renderMath() {
            renderMathInElement(document.getElementById('quiz-screen'), {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ]
            });
        }

        function showQuestion() {
            isLocked = false;
            const q = currentQuestions[currentIndex];
            document.getElementById('progress-tag').innerText = `C√¢u ${currentIndex + 1}/${currentQuestions.length}`;
            document.getElementById('question-text').innerHTML = q.q;
            
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            
            q.a.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = "option-btn p-4 text-left rounded-xl text-slate-300 font-medium text-sm flex gap-3 items-center";
                btn.innerHTML = `<span class="w-6 h-6 flex-shrink-0 flex items-center justify-center rounded-lg bg-slate-800 text-[10px] font-black">${String.fromCharCode(65+i)}</span> <span>${opt}</span>`;
                btn.onclick = () => checkAnswer(i, btn);
                container.appendChild(btn);
            });
            renderMath();
        }

        function checkAnswer(idx, btn) {
            if (isLocked) return;
            isLocked = true;

            const q = currentQuestions[currentIndex];
            const buttons = document.querySelectorAll('.option-btn');

            if (idx === q.c) {
                score++;
                btn.classList.add('correct');
                document.getElementById('score-tag').innerText = `ƒê√∫ng: ${score}`;
            } else {
                btn.classList.add('wrong');
                buttons[q.c].classList.add('correct');
            }

            setTimeout(() => {
                if (currentIndex < currentQuestions.length - 1) {
                    currentIndex++;
                    showQuestion();
                } else {
                    finishQuiz();
                }
            }, 1200);
        }

        function finishQuiz() {
            clearInterval(timerInterval);
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('final-score').innerText = `${score}/${currentQuestions.length}`;
            document.getElementById('final-time').innerText = `${seconds}s`;
            saveResultToCloud();
        }

        // Init
        window.onload = loadLeaderboard;
    </script>
</body>
</html>